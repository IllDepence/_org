<!doctype html>
<html>
<head>
<meta charset="utf-8">
<script src="FileSaver.js/FileSaver.js"></script>
</head>
<body>
<div style="margin-bottom: 20px">
	<input type="button" onclick="saveTags()" value="save tags" />
	<input type="text" oninput="applyFilter(this.value)" />
</div>
<div id="info"></div>
<div id="images"></div>
<script>
var IMG_MAX_DIM = 300;
var MAX_IMG_DISP = 10;
function applyFilter(text) {
	// TODO: actually apply a filter
	var img_list = sessionStorage.getItem("img_list");
	displayImages(img_list);
	}
function readLocalTextFile(file, purpose) {
	var rawFile = new XMLHttpRequest();
	rawFile.open("GET", file, true);
	rawFile.onreadystatechange = function () {
		if(rawFile.readyState === 4) {
			if(rawFile.status === 200 || rawFile.status == 0) {
				if(purpose == "img_list")
					sessionStorage.setItem("img_list", rawFile.responseText);
				if(purpose == "tags")
					sessionStorage.setItem("tag_obj", rawFile.responseText);
				}
			}
		}
	rawFile.send(null);
	}
function displayImages(list) {
	var arr = list.split("\n");
	for(var i = 0; i<MAX_IMG_DISP; i++) {
		var img_div = document.querySelector("#images");
		var a = document.createElement("a");
		a.style="cursor: pointer;";
		a.setAttribute("onclick", "receiveTags('"+arr[i]+"')");
		var img = new Image();
		img.onload = function() {
			if(this.width > this.height) {
				this.width = IMG_MAX_DIM;
				this.height = IMG_MAX_DIM * (this.height/this.width);
				}
			else {
				this.height = IMG_MAX_DIM;
				this.width = IMG_MAX_DIM * (this.width/this.height);
				}
			}
		img.src=img_path+arr[i];
		img_div.appendChild(a);
		a.appendChild(img);
		}
	}
function getTagObject() {
	var obj = JSON.parse(sessionStorage.getItem("tag_obj"));
	if(obj == null)
		var obj = {};
	return obj;
	}
function receiveTags(fname) {
	var obj = getTagObject();
	var exTags = [];
	if(typeof(obj[fname]) != "undefined")
		exTags = (obj[fname]);
	var taglist = window.prompt("tags for "+fname, exTags.toString(","));
	if(taglist != null)
		addTags(fname, taglist);
	}
function addTags(fname, taglist) {
	var obj = getTagObject();
	obj[fname] = taglist.split(",");
	sessionStorage.setItem("tag_obj", JSON.stringify(obj));
	}
function saveTags() {
	var blob = new Blob([sessionStorage.getItem("tag_obj")]);
	var blob_url = window.URL.createObjectURL(blob);
	saveAs(blob, "tags");
	}
var img_path = document.URL.substr(0, document.URL.length-"_org/index.html".length);
var img_list = img_path+"_org/files";
var tag_file = img_path+"_org/tags";
readLocalTextFile(img_list, "img_list");
readLocalTextFile(tag_file, "tags");
</script>
</body>
</html>
